<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Password Protected URL</title>
</head>
<body>
  <h1>Password Protected URL</h1>
  <form method="POST" action="{{ url_for('URL.redirect_to_original', short_id=short_id) }}">
    {% if error %}
      <p style="color:red;">{{ error }}</p>
    {% endif %}
    <label for="password">Password:</label>
    <input type="password" id="password" name="password" required>
    <button type="submit">Submit</button>
  </form>
</body>
</html>
import string
from datetime import datetime,timedelta
from flask import render_template, request, session, jsonify, abort, redirect
from . import bp
from .models import URLMapping,AccessLog
from app import db
import hashlib

@bp.route('/')
def home():
    return render_template('home.html')

BASE_URL = "https://short.ly"
def generate_short_id(original_url):
    hash_object = hashlib.md5(original_url.encode())
    return hash_object.hexdigest()[:6]


@bp.route('/shorten', methods=['GET', 'POST'])
def shorten_url():
    if request.method == 'POST':
        original_url = request.form['original_url']
        expiration_time = request.form.get('expiration_time')

        try:
            expiration_hours = int(expiration_time) if expiration_time else 24
        except ValueError:
            expiration_hours = 24

        if not original_url:
            return render_template('index.html', error="Invalid URL")
        existing_mapping = URLMapping.query.filter_by(original_url=original_url).first()

        if existing_mapping:
            if expiration_time:
                existing_mapping.expiration_time = datetime.utcnow() + timedelta(hours=expiration_hours)
            short_id = existing_mapping.short_id
            db.session.commit()
        else:
            short_id = generate_short_id(original_url)
            expiration_time = datetime.utcnow() + timedelta(hours=expiration_hours)

            new_mapping = URLMapping(
                original_url=original_url,
                short_id=short_id,
                expiration_time=expiration_time
            )
            db.session.add(new_mapping)
            db.session.commit()
        short_url = f'{BASE_URL}/{short_id}'
        return render_template('index.html', short_url=short_url)

    return render_template('index.html')



@bp.route('/<short_id>', methods=['GET'])
def redirect_to_original(short_id):
    mapping = URLMapping.query.filter_by(short_id=short_id).first()
    if not mapping or mapping.expiration_time < datetime.utcnow():
        abort(404, description="URL not found or expired")
    mapping.access_count = mapping.access_count + 1 if mapping.access_count else 1
    db.session.commit()
    ip_address = request.remote_addr  # Get the user's IP address
    access_log = AccessLog(short_id=short_id, ip_address=ip_address)
    db.session.add(access_log)
    db.session.commit()
    return redirect(mapping.original_url)


@bp.route('/analytics/<short_id>', methods=['GET'])
def analytics(short_id):
    mapping = URLMapping.query.filter_by(short_id=short_id).first()
    if not mapping:
        return render_template('error.html', error="Short URL not found")

    access_logs = AccessLog.query.filter_by(short_id=short_id).all()
    analytics_data = {
        "short_url": f"{BASE_URL}/{short_id}",
        "original_url": mapping.original_url,
        "created_at": mapping.created_at,
        "access_count": mapping.access_count or 0,
        "logs": [
            {"ip_address": log.ip_address, "timestamp": log.accessed_at}
            for log in access_logs
        ]
    }

    return render_template('analytics.html', analytics_data=analytics_data)

